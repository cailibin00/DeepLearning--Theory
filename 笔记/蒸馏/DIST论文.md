## 思考
### get
- 全局和实例
### question

- PCC的梯度不好计算，对于所有样本求和太繁杂了 （解决，根据批次计算）
- PCC的相关性真的拟合的很好吗，没有精确值，看起来不像是一个很好的损失函数。并且只能适用于分类
- 有时候教师模型做出模糊判断是被场景误导，并且这只适用于分类。如果在全局上使用，可能会误导模型，这可能适用于**图像分割**之后的检测。
- 如果当个样本拟合效果很好，何必要在全局再做一次

## 前言
KD是knowledge Distill知识蒸馏 ， DIST是本文提出的观点
B1 ， B2是一种训练策略
![](file-20250930161819611.png)
![](file-20250930161843279.png)

- **挑战一**：当教师模型越来越强大（**大尺寸或先进训练策略如标签平滑、数据增强**），KD出现了无法跟上学习的现象，表现为准确率下降
- **挑战二**：当训练策略优化，教师模型得到了更好的结果，kd却出现了比不kd更坏的结果

核心观点：
**蒸馏的核心是保留教师模型输出的结果的相对关系，而不是绝对的准确值（直接学习准确值seems way too overambitious and demanding），我们需要改进KL散度（放宽限制），使得学生更好的学习相对关系**。

## 创新
![](file-20250930161909120.png)

### 输出概率
- 两者都进行温度处理 , 实验中温度取4
$$y^{(t)} = softmax(\frac{y^{(t)}}{t})$$
$$y^{(s)} = softmax(\frac{y^{(s)}}{t})$$

### PCC
PCC是**皮尔逊相关系数（Pearson Correlation Coefficient, PCC）**
是衡量 **类间关系损失**的指标。“类间关系” 指**单个实例对所有类别的概率排序关系**（例如：教师模型认为 “实例 1 属于类 A 的概率> 类 B > 类 C”，学生模型需**保留这种排序**，而非精确匹配概率值）

PCC 本质是 “归一化后的协方差”，能反映两个变量的线性相关程度（取值范围([-1,1])），越接近 1 说明关系越一致；若直接用 PCC 作为 “匹配指标”，则损失可定义为 “1 - PCC”（即皮尔逊距离），损失越小表示师生关系越一致。

> 有点类似于我们的**线性相关系数**（实际上就是），一堆离散数据根据公式判断是否线性相关，分子那一块能够根据面积来模拟推导，要是线性相关，面积相加减会变得很大，要是出现一些不和谐的点，就会导致面积变小或者变成负数。从而得到是否线性相关


在线性相关函数之中，r=1表示随着x增大，y增大的线性相关性最强，r=-1x增大，y减小。r=0表示x增大，y可能减小可能增大。
那么我们根据这个思想，推广一下，如果我们将学生模型输入作为y，教师模型输入作为y，那么我们想要他们的排序相同，也就是x增大，y应该随之增大，这样就构成了顺序关系

给出公式，针对一个样本i ， **基于一个批次**
$$r_i = \frac{Cov(Y^{(s)} , Y^{(Y^{(t)})}) }{Std(Y^{(t)})Std(Y^{(s)})}$$
$$r_i = \frac{\sum_{j=1}^{C} {(Y^{(s)}_{i,j} -\overline{Y^{(s)}_{i,:}} )(Y^{(t)}_{i,j} -\overline{Y^{(t)}_{i,:}})}}{\sqrt{\sum_{j=1}^{C}{(Y^{(s)}_{i,j} - \overline{Y^{(s)}_{i,:}}})} \cdot \sqrt{\sum_{j=1}^{C}{(Y^{(t)}_{i,j} - \overline{Y^{(t)}_{i,:}}})}}$$
这个 $P_i$ 描述了教师和学生两者的线性相关性，我们需要确保它能够接近最大值，根据梯度优化的原理，损失值应该设定为
$$L_{inter} = \frac{1}{B} \cdot\sum_{i=1}^{B}(1 - r_i)$$
### intra
统计针对于单个类别的所有预测（教师和学生），输出针对于一个类别的唯一向量，该向量能够根据全局数据统计“看到”这个类别的时候，最有可能和什么类别混淆。
简单来说，就是根据全局输出，对于每一个类别输出一个向量，例如类别A的向量，记录了(类别A > 类别C > 类别D  ...... )，这个向量能够代表这个类别

值得注意的是，这是**基于一个批次统计的**

损失函数 , C表示类别 
$$L_{intra} = \frac{1}{C}\sum_{j=1}^{C}{(1 - p_j)}$$
所以说，在全局上修正了学生模型和教师模型预测的结果偏差

### 损失函数
$$L = \alpha L_{cls} + \beta L_{inter} + γL_{intra}$$

